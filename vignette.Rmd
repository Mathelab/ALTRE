---
title: 'ALTRE: vignette'
author: "Ewy Mathe, Elizabeth Baskin, and Rick Farouni"
date: '`r Sys.Date()`'
output: html_document
vignette: >
  %\VignetteIndexEntry{ALTRE: vignette} 
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


#Introduction

ALTRE (ALTered Regulatory Elements) is an R software package that streamlines and simplifies the analysis of data generated from genome-wide chromatin accessibility assays such as DNase-seq (a.k.a. DHS-seq), FAIRE-seq, and ATAC-seq.

Regulatory elements (REs) are involved in regulating gene transcription – they control genes and pathways that can be investigated as putative therapeutic targets, or they may serve as targets themselves. Chromatin accessibility assays allow us to identify the location of REs genome-wide by identifying “open” chromatin (i.e. euchromatin). Identifying REs that differ between cell types, such as cancerous and noncancerous cell lines and tissues, holds promise for discovering new mechanisms involved in cellular development and disease progression. 

#Workflow

ALTRE takes as input a CSV file which provides the names and metadata information for the alignment files (BAM format) and peak files (BED format) of samples to be analyzed.  The software then takes users through defining altered peaks using both binary data (presence/absence of peaks) and quantitative data (peak intensity). Moreover, the package includes functions that merge and annotate peaks (e.g. as TSS-proximal and TSS-distal), perform enrichment analysis for REs of interest, and provide visualization functions. The analysis can be conducted through the R command line or through an RShiny web interface for those who are not familiar with the R statistical language. This vignette further explains the purpose of the package and establishes the workflow.

###Graphing analysis results

Results of this analysis will be displayed in a number of graphs throughout the workflow. These graphs are interactive -- mouse-over data points to find further information, such as the exact coordinates (e.g. p-value) of a plotted sample, or click a sample or condition in the legend to hide it from the graph -- this can allow the remaining samples to be compared more easily as the graph will zoom in and out to accommodate changes.

###Example data 

To demonstrate the functionality of ALTRE, we have provided an example dataset (BAM and BED files) of cancerous (A549) and normal (SAEC) lung cell types downloaded from the ENCODE project (see <https://mathelab.github.io/ALTREsampledata/>). Of note, this vignette uses only a subset of the data corresponding to Chromosome 21 (results may not be as meaningful). 

**1. Load Data** 

*Load Metadata*
The metadata associated with data files to be analyzed in ALTRE is supplied as a CSV file. The software will automatically retrieve the file path of your input CSV so __it is important that all analysis files are in the same folder as your CSV file.__  

After downlading all files in the example datasets in one folder, download the CSV at <https://raw.githubusercontent.com/mathelab/AltreDataRepo/master/DNaseEncodeExample.csv> and place it in the same folder.  Also, be sure to set your working directory in the R environment to point to the directory where you have placed your CSV file.

```{r}
library(ALTRE)
csvfile <- loadCSVFile("DNaseEncodeExample.csv")
csvfile
```

*Load peak files*
Read in the peak files (BED format) with the *loadBedFiles()* function.  Only the first three columns (chr, start, end) of the peak files are required an read in. Additional columns are allowed but ignored.

```{r, message=FALSE}
samplePeaks <- loadBedFiles(csvfile)
samplePeaks
```

**2. Get Reproducible Peaks**

In the second step, ALTRE identifies consensus peaks among sample replicates – peaks that are present in all (or, less stringently, the majority) of sample replicates. The function *getConsensusPeaks()* processes an input of two or more peak files per sample and returns a GRanges list. At least two biological replicates are required in order to identify consensus peaks.

```{r}
consensusPeaks <- getConsensusPeaks(samplepeaks = samplePeaks,
                                    minreps = 2)
```

The function *plotConsensusPeaks()* creates a bar graph comparing the number of replicate peaks identified vs. total number of peaks.

```{r}
plotConsensusPeaks(samplepeaks = consensusPeaks)
```

**3. Annotate Peaks**

The output of the function *getConsensusPeaks()* is then further processed by the *combineAnnotatePeaks()* function, which in turn accomplishes three main tasks:

  1. Combines consensus peaks for each samples type into one large master list of peaks for each sample type. 

  2. Categorizes peaks as TSS-proximal and TSS-distal, based on the distance of the peaks from a transcription start site (TSS). In this vignette we will use the default promoter distance argument: peaks within 1,500 bp of a TSS are considered TSS-proximal; those not within 1,500 bp of a TSS are considered TSS-distal.

  3. Optionally, merges peaks within a certain distance of each other. Merging close-by peaks loosens the stringency of the region comparison. Multiple regions of active chromatin within ~1000 bp are likely to represent only one regulatory element. In this vignette we will use the defaults of the function, which merges regions within 1000 bp of each other and merges only within regulatory element type (i.e. only TSS-distal will only be merged with other TSS-distal, and likewise, TSS-proximal only with TSS-proximal). Both these functionalities can be changed via the “distancefromTSSprox”, “distancefromTSSdist” and “regionspecific” arguments.

The *combineAnnotatePeaks()* function requires a list of TSSs for the TSS-proximal/TSS-distal annotation, which can be read in with the *getTSS()* function:
```{r}
TSSannot <- getTSS()
```

Then the function can be run with: 

```{r}
consensusPeaksAnnotated <- combineAnnotatePeaks(conspeaks = consensusPeaks,
                                           TSS = TSSannot,
                                           merge = TRUE,
                                           regionspecific = TRUE,
                                           distancefromTSSdist = 1500,
                                           distancefromTSSprox = 1000)
```


Note that the output of the previous function *getConsensusPeaks()* is fed as input (consensPeaks).

The output of *combineAnnotatePeaks()* produces a GRanges object containing the annotated, merged peaks – all peaks present in cancerous or normal lung.

Additionally, the function *plotCombineAnnotatePeaks()* creates a bar graph to showcase the changes in the number and size of TSS-distal and TSS-proximal elements before and after merging close-by peaks.

```{r}
plotCombineAnnotatePeaks(consensusPeaksAnnotated)
```

The number of regulatory elements decreases and the size of the regions increases, as expected.


**4. Get Read Counts**

The next function *getCounts()* retrieves the number of reads in each regulatory element (RE) for each sample type – this determines the peak height/intensity and approximates the accessibility of the RE in question.  Read counts are retrieved from the alignment files (BAM format) that are supplied in the CSV file containing the sample metadata.  We have already read in the CSV in the first step of the workflow (load data).  

Of note, one cell type must be designated as  “reference ”, to which the other cell types will be compared. In this example, the reference type is the normal lung cell line (SAEC).

To run the function:
```{r}
consensusPeaksCounts <- getCounts(annotpeaks = consensusPeaksAnnotated,
                              sampleinfo = csvfile,
                              reference = 'SAEC',
                              chrom = 'chr21')
plotGetCounts(consensusPeaksCounts)
```


**5. Retrieve and Categorize Candidate Altered Regulatory Elements (REs)**

The counts for each REs are processed by the function *countanalysis()*, which leverages the algorithm from the R package DESeq2 to compare peak intensities across cell types.  

```{r}
alteredPeaks <- countanalysis(counts = consensusPeaksCounts,
                             pval = 0.01,
                             lfcvalue = 1)

```

Altered REs are next categorized based on associated log2 fold changes and p-values, where larger log2 fold changes and smaller p-values mark REs with a change in signal magnitude between the two cell-types that is unlikely to be caused by chance alone. What magnitude (p-value/log2 fold) is considered cell-type specific is left up to the user.

```{r}
alteredPeaksCategorized <- categAltrePeaks(alteredPeaks,
                                    lfctypespecific = 1.5,
                                    lfcshared = 1.2,
                                    pvaltypespecific = 0.01,
                                    pvalshared = 0.05)
plotCountAnalysis(alteredPeaksCategorized)
```

REs with larger, positive log2 fold changes and smaller p-values have strong statistical evidence indicating that the DNA is more accessible in the lung cancer cell type compared to the normal lung tissue. Therefore, their activity is considered associated with the cancer phenotype. REs with larger, negative log2fold changes and smaller p-values indicate the opposite -- the DNA is less accessible in the cancer type and may therefore be associated with tumor suppressive properties. REs with minimal log2fold change and high p-values are equally accessible in both cell types, and therefore, their activity is more likely to contribute to the house-keeping functions required in every cell.

The function *plotDistCountAnalysis()* enables users to view the raw count data in regions identified as type-specific or shared. The log2 transformation of reads per kilo-base per million for each RE is plotted. As expected, for REs identified as higher log-fold change than normal, the lung cancer cell line has much higher counts than he normal lung cell line. The opposite is true for the lower log-fold change regions. For RE with little log-fold change between cell types, the counts are similar. This visual depiction confirms the results of countanalysis and enables users to change parameters if needed.

```{r}
plotDistCountAnalysis(alteredPeaksCategorized, consensusPeaksCounts)
```


**6. Method Comparison** 

Once results have been obtained there are additional functions in ALTRE to compare the two major methods for identifying altered REs:

Method 1: based on peak intensity (ALTRE's *countanalysis()* function)\

Method 2: based on peak presence or absence as determined by the peak calling algorithm

To compare resulting altered REs from these two methods, use the function *comparePeaksAltre* as follows:

```{r}
comparePeaksAnalysisResults <- comparePeaksAltre(alteredPeaksCategorized)
```

The function *plotCompareMethodsAll()* takes the results from comparePeaksAltre and translates the table into pie charts.


```{r}
plotCompareMethodsAll(comparePeaksAnalysisResults)
```


**7. Get Putative Enrichment Pathways** 

Finally, ALTRE performs pathway enrichment analysis, using [rGREAT](https://bioconductor.org/packages/release/bioc/html/rGREAT.html), for cell type-specific or shared REs using the functions *runGREAT()* and *processPathways()*. The GREAT algorithm incorporates proximal and distal binding sites and uses a binomial testing procedure to mitigate false positives.  More information on the algorithm can be found [here](http://bejerano.stanford.edu/great/public/html/). Enriched” pathways are likely to be regulated by the REs linked to the gene cluster (whether type-specific or shared).

In the web application, Gene Ontology pathway annotations are used by default, and include 1) Molecular Function (MF); 2) Biological Process (BP); 3) Cellular Component (CC)).  GREAT however allows other pathway categories to be analyzed, including "Pathway Data", "Regulatory Motifs","Phenotype Data and Human Disease", "Gene Expression", and "Gene Families".  These pathway categories can be passed onto the *runGREAT()* function via the paramter pathway_category.

By default, the p-values will be adjusted by "bonferroni" and significant pathways will have adjusted p-values < 0.05 and an enrichment of at least 2.

Note that this vignette only uses Chromosome 21, therefore the pathway analysis results presented may not be biologically relevant.  

```{r, eval = FALSE}
callPaths <- runGREAT(peaks = alteredPeaksCategorized)
enrichmentTables <- processPathways(callpaths, pathway_category = "GO",
	enrichcutoff = 2, adjpvalcutoff = 0.05)
```

```{r, echo = FALSE, message = FALSE}
captured <- capture.output(callpaths <- runGREAT(peaks = alteredPeaksCategorized))
pathresults <- processPathways(callpaths, pathway_category = "GO",
	enrichcutoff = 2, adjpvalcutoff = 0.05)
```


The function *plotGREATenrich()* creates a heatmap plot of the analysis for all three RE types (Reference-specific, Experiment-specific, and Shared), with the color-coding corresponding to the significance of the pathway – the lighter the blue, the lower the p-value. 

```{r}
plotGREATenrich(pathresults, maintitle = "GREAT Enrichment Analysis",
	pathwaycateg = "GO_Molecular_Function")
```

**8. Writing output to files**
To enable users to write results to files, the following 4 functions are implemented:

1. *writeBedFile()*: writes a BED file in the working directory with the location of REs, color-coded by type-specificity.  The output BED file can be directly loaded in a genome browser. There is no output to the function that can be saved as an object.

```{r, eval = FALSE}
writeBedFile(alteredPeaksCategorized, "altrecategpeaks.bed")
```

2. *writeConsensusRE()*: writes a CSV file in the working direcoty with the location of the consensus regulatory elements, along with their annotation (e.g. TSS-proximal/distal, whether the peaks are found in the experiment or reference samples).  The file takes as input the output of the getConsensusPeaks() function and returns no output.  

```{r, eval=FALSE}
writeConsensusRE(consensusPeaksAnnotated, "altreconspeaks.csv")
```

3. *writeCompareRE()*: writes a CSV file with the number of peaks called as experiment- or reference-specific and share using qthe quantitative/peak intensity or peak/binary approach. The function takes the output of comparePeaksAltre() as input and returns no output.  

```{r, eval = FALSE}
writeCompareRE(comparePeaksAnalysisResults, "comparealtrepeaks.csv")
```

4. *writeGREATpath()*: writes CSV files showing the results of the functions runGREAT() and processPathways(), which it takes as input.  A zipped folder containing 3xP CSV files will be created, where 3 is the type of REs (e.g. Shared, Reference-specific, and Experiment-specific), and P is the number of pathways (e.g. if GO pathway category is used, then P is 3 - Molecular Function, Cellulcar function, Biological Processes).  

```{r, eval = FALSE}
writeGREATpath(pathresults, "EnrichedPathways.zip")
```

```{r}
sessionInfo()
```
